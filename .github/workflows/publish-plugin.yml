name: Publish Saltshaker Plugin

on:
  workflow_dispatch:
    inputs:
      plugin:
        description: "Plugin folder name (e.g. slippi-ssbm)"
        required: true
      version:
        description: "Version number (e.g. 1.0.1)"
        required: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build plugin package
        working-directory: plugins/${{ github.event.inputs.plugin }}
        run: |
          npm ci
          npm pack
          ls -lh *.tgz

      - name: Compute SHA-256
        id: hash
        run: |
          FILE=$(ls plugins/${{ github.event.inputs.plugin }}/*.tgz)
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "sha=$(sha256sum $FILE | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.plugin }}-v${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.plugin }} v${{ github.event.inputs.version }}
          files: ${{ steps.hash.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update plugin manifest
        run: |
          plugin=${{ github.event.inputs.plugin }}
          version=${{ github.event.inputs.version }}
          sha=${{ steps.hash.outputs.sha }}
          url="https://github.com/${{ github.repository }}/releases/download/${plugin}-v${version}/saltshaker-plugin-${plugin}-${version}.tgz"
          manifest="catalog/plugins/${plugin}.json"

          # Update manifest JSON
          jq --arg v "$version" \
             --arg u "$url" \
             --arg s "$sha" \
             '.version=$v | .artifactUrl=$u | .sha256=$s | .minClientVersion="0.2.10"' \
             "$manifest" > tmp.json && mv tmp.json "$manifest"

          # Update catalog index
          jq --arg id "$plugin" \
             --arg path "plugins/${plugin}.json" \
             --arg latest "$version" \
             '(.plugins[] | select(.id==$id)).latest=$latest' \
             catalog/index.json > tmp.json && mv tmp.json catalog/index.json

      - name: Commit and push updated catalog
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add catalog/
          git commit -m "Update ${plugin} to v${version}"
          git push
