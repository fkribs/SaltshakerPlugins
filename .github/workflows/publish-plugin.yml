name: Publish Saltshaker Plugin

on:
  workflow_dispatch:
    inputs:
      plugin:
        description: "Plugin ID (e.g. slippi:ssbm)"
        required: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout registry repo
        uses: actions/checkout@v4

      #
      # READ MANIFEST METADATA
      #
      - name: Read plugin manifest
        id: manifest
        run: |
          plugin="${{ github.event.inputs.plugin }}"
          short="${plugin##*:}"   # slippi:ssbm -> ssbm

          manifest="catalog/plugins/$short.json"
          echo "manifest_file=$manifest" >> $GITHUB_OUTPUT

          repo=$(jq -r '.repository' "$manifest")
          version=$(jq -r '.version' "$manifest")
          commit=$(jq -r '.commit // empty' "$manifest")

          if [ -z "$commit" ]; then
            echo "ERROR: plugin manifest missing 'commit'"
            exit 1
          fi

          echo "plugin_repo=$repo" >> $GITHUB_OUTPUT
          echo "plugin_version=$version" >> $GITHUB_OUTPUT
          echo "plugin_commit=$commit" >> $GITHUB_OUTPUT
          echo "plugin_short=$short" >> $GITHUB_OUTPUT

      #
      # CLONE UPSTREAM PLUGIN SOURCE CODE
      #
      - name: Clone plugin source
        run: |
          git clone ${{ steps.manifest.outputs.plugin_repo }} plugin-source
          cd plugin-source
          git checkout ${{ steps.manifest.outputs.plugin_commit }}

      #
      # BUILD + PACK
      #
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies & build
        working-directory: plugin-source
        run: |
          npm ci
          npm run build || true
          npm pack
          ls -lh *.tgz

      #
      # COPY BUILT ARTIFACT
      #
      - name: Move built artifact
        run: |
          short="${{ steps.manifest.outputs.plugin_short }}"
          version="${{ steps.manifest.outputs.plugin_version }}"

          mkdir -p plugins/$short
          mv plugin-source/*.tgz "plugins/$short/saltshaker-plugin-$short-$version.tgz"

      #
      # HASH
      #
      - name: Compute SHA-256
        id: hash
        run: |
          short="${{ steps.manifest.outputs.plugin_short }}"
          version="${{ steps.manifest.outputs.plugin_version }}"
          file="plugins/$short/saltshaker-plugin-$short-$version.tgz"

          echo "file=$file" >> $GITHUB_OUTPUT
          echo "sha=$(sha256sum $file | awk '{print $1}')" >> $GITHUB_OUTPUT

      #
      # RELEASE
      #
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.manifest.outputs.plugin_short }}-v${{ steps.manifest.outputs.plugin_version }}
          name: ${{ github.event.inputs.plugin }} v${{ steps.manifest.outputs.plugin_version }}
          files: ${{ steps.hash.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #
      # UPDATE MANIFEST
      #
      - name: Update plugin manifest metadata
        run: |
          manifest="${{ steps.manifest.outputs.manifest_file }}"
          short="${{ steps.manifest.outputs.plugin_short }}"
          version="${{ steps.manifest.outputs.plugin_version }}"
          sha="${{ steps.hash.outputs.sha }}"

          url="https://github.com/${{ github.repository }}/releases/download/${short}-v${version}/saltshaker-plugin-${short}-${version}.tgz"

          jq --arg v "$version" \
             --arg u "$url" \
             --arg s "$sha" \
             '.version=$v | .artifactUrl=$u | .sha256=$s' \
             "$manifest" > tmp.json && mv tmp.json "$manifest"

      #
      # UPDATE INDEX
      #
      - name: Update catalog index
        run: |
          plugin="${{ github.event.inputs.plugin }}"
          id="$plugin"
          short="${{ steps.manifest.outputs.plugin_short }}"
          version="${{ steps.manifest.outputs.plugin_version }}"

          jq --arg id "$id" \
             --arg latest "$version" \
             '(.plugins[] | select(.id==$id)).latest=$latest' \
             catalog/index.json > tmp.json && mv tmp.json catalog/index.json

      #
      # COMMIT & PUSH
      #
      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add catalog/ plugins/
          git commit -m "Publish plugin ${{ github.event.inputs.plugin }} version ${{ steps.manifest.outputs.plugin_version }}" || echo "No changes"
          git push
